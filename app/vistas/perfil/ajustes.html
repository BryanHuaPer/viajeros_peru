<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ajustes de Perfil - Viajeros Per√∫</title>
    <link rel="icon" href="../../../public/img/logos/logo.png" type="image/x-icon">
    <link rel="stylesheet" href="/proyectoWeb/viajeros_peru/public/css/estilo_principal.css">
    <link rel="stylesheet" href="/proyectoWeb/viajeros_peru/public/css/panel_control.css">
    <style>
        /* Indicar que esta p√°gina no necesita la navegaci√≥n principal */
        .navegacion-principal, .menu-hamburguesa {
            display: none;
        }

        .navegacion .menu-usuario .contenedor-configuracion{
            display: none;
        }

        body {
            background-color: #f5f6fa;
        }

        .ajustes-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .ajustes-titulo {
            font-size: 28px;
            font-weight: bold;
            color: #ffffff;
            margin: 0;
        }

        .seccion-ajustes {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #3498db;
        }

        .seccion-ajustes h3 {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 0;
        }

        .icono-seccion {
            font-size: 22px;
        }

        .grupo-control {
            margin-bottom: 20px;
        }

        .grupo-control:last-child {
            margin-bottom: 0;
        }

        .etiqueta {
            display: block;
            font-weight: 500;
            color: #34495e;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .etiqueta-obligatoria::after {
            content: " *";
            color: #e74c3c;
        }

        .descripcion-campo {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 4px;
            margin-left: 4px;
        }

        select,
        input[type="text"],
        input[type="email"],
        input[type="password"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
            box-sizing: border-box;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        select:focus,
        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="password"]:focus,
        textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .opciones-radio {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .opcion-radio {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            border: 1px solid #ecf0f1;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .opcion-radio:hover {
            background-color: #f8f9fa;
            border-color: #3498db;
        }

        .opcion-radio input[type="radio"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            margin-top: 2px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .opcion-radio input[type="radio"]:checked {
            accent-color: #27ae60;
        }

        .etiqueta-opcion {
            flex: 1;
            cursor: pointer;
        }

        .titulo-opcion {
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 4px;
            display: block;
        }

        .descripcion-opcion {
            font-size: 12px;
            color: #7f8c8d;
        }

        .botones-accion {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #ecf0f1;
        }

        .boton {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            flex: 1;
        }

        .boton-guardar {
            background-color: #27ae60;
            color: white;
        }

        .boton-guardar:hover:not(:disabled) {
            background-color: #229954;
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
        }

        .boton-guardar:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .boton-cancelar {
            background-color: #95a5a6;
            color: white;
        }

        .boton-cancelar:hover {
            background-color: #7f8c8d;
        }

        /* Estilos para notificaciones flotantes (Toasts) */
        .mensaje-exito,
        .mensaje-error {
            position: fixed; /* Fija el mensaje a la pantalla, no al documento */
            top: 20px;
            right: 20px;     /* Esquina superior derecha */
            z-index: 9999;   /* Asegura que est√© encima de todo */
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); /* Sombra para dar profundidad */
            font-weight: 500;
            min-width: 300px;
            display: none;   /* Oculto por defecto */
            animation: slideIn 0.5s ease forwards; /* Animaci√≥n de entrada */
        }

        /* Colores espec√≠ficos */
        .mensaje-exito {
            background-color: #d4edda;
            border-left: 5px solid #28a745; /* Borde verde a la izquierda */
            color: #155724;
        }

        .mensaje-error {
            background-color: #f8d7da;
            border-left: 5px solid #dc3545; /* Borde rojo a la izquierda */
            color: #721c24;
        }

        /* Clase para mostrarlo */
        .mensaje-exito.mostrar,
        .mensaje-error.mostrar {
            display: block;
        }

        /* Animaci√≥n para que entre desliz√°ndose suavemente */
        @keyframes slideIn {
            from {
                transform: translateX(100%); /* Empieza fuera de la pantalla a la derecha */
                opacity: 0;
            }
            to {
                transform: translateX(0);    /* Termina en su sitio */
                opacity: 1;
            }
        }

        /* Ajuste para m√≥viles: que salga abajo o ocupe el ancho */
        @media (max-width: 768px) {
            .mensaje-exito,
            .mensaje-error {
                top: auto;
                bottom: 20px; /* En m√≥vil, mejor abajo para que el dedo no lo tape */
                right: 10px;
                left: 10px;   /* Ocupa el ancho */
                min-width: auto;
            }
        }

        .cargando {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .ajustes-container {
                padding: 15px;
            }

            .ajustes-titulo {
                font-size: 22px;
            }

            .seccion-ajustes {
                padding: 18px;
            }

            .botones-accion {
                flex-direction: column;
            }

            .boton {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="navegacion-global">
        <!-- La navegaci√≥n se cargar√° aqu√≠ autom√°ticamente -->
    </div>

    <div class="ajustes-container">
        <header class="header-panel">
            <h1 class="ajustes-titulo">‚öôÔ∏è Ajustes de Perfil</h1>
        </header>

        <!-- Mensajes de estado -->
        <div id="mensajeExito" class="mensaje-exito">
            <strong>‚úì Cambios guardados exitosamente</strong>
        </div>
        <div id="mensajeError" class="mensaje-error">
            <strong>‚úó Error al guardar los cambios</strong>
        </div>

        <!-- Contenedor del formulario -->
        <form id="formularioAjustes" method="POST">

            <!-- SECCI√ìN 1: PREFERENCIAS DE IDIOMA Y ZONA HORARIA (RP1) -->
            <div class="seccion-ajustes">
                <h3>
                    <span class="icono-seccion">üåê</span>
                    Preferencias de Idioma y Zona Horaria
                </h3>

                <!-- Selecci√≥n de Idioma -->
                <div class="grupo-control">
                    <label class="etiqueta etiqueta-obligatoria">Idioma de la Interfaz</label>
                    <select name="idioma" id="idioma" required>
                        <option value="">Selecciona un idioma</option>
                        <option value="es">Espa√±ol</option>
                        <option value="en">English (Ingl√©s)</option>
                    </select>
                    <div class="descripcion-campo">
                        El idioma seleccionado se aplicar√° a toda la interfaz de la aplicaci√≥n
                    </div>
                </div>

                <!-- Selecci√≥n de Zona Horaria -->
                <div class="grupo-control">
                    <label class="etiqueta etiqueta-obligatoria">Zona Horaria</label>
                    <select name="zona_horaria" id="zonaHoraria" required>
                        <option value="">Selecciona tu zona horaria</option>
                        <optgroup label="Per√∫">
                            <option value="America/Lima">Per√∫ (UTC-5)</option>
                        </optgroup>
                        <optgroup label="Am√©rica del Sur">
                            <option value="America/Caracas">Venezuela (UTC-4)</option>
                            <option value="America/Bogota">Colombia (UTC-5)</option>
                            <option value="America/Quito">Ecuador (UTC-5)</option>
                            <option value="America/La_Paz">Bolivia (UTC-4)</option>
                            <option value="America/Santiago">Chile (UTC-3)</option>
                            <option value="America/Argentina/Buenos_Aires">Argentina (UTC-3)</option>
                            <option value="America/Sao_Paulo">Brasil (UTC-3)</option>
                        </optgroup>
                        <optgroup label="Am√©rica Central y del Norte">
                            <option value="America/Mexico_City">M√©xico (UTC-6)</option>
                            <option value="America/New_York">EE.UU. - Este (UTC-5)</option>
                            <option value="America/Chicago">EE.UU. - Centro (UTC-6)</option>
                            <option value="America/Denver">EE.UU. - Monta√±a (UTC-7)</option>
                            <option value="America/Los_Angeles">EE.UU. - Oeste (UTC-8)</option>
                        </optgroup>
                        <optgroup label="Europa">
                            <option value="Europe/Madrid">Espa√±a (UTC+1)</option>
                            <option value="Europe/London">Reino Unido (UTC+0)</option>
                            <option value="Europe/Paris">Francia (UTC+1)</option>
                            <option value="Europe/Berlin">Alemania (UTC+1)</option>
                        </optgroup>
                        <optgroup label="Asia">
                            <option value="Asia/Manila">Filipinas (UTC+8)</option>
                            <option value="Asia/Bangkok">Tailandia (UTC+7)</option>
                            <option value="Asia/Tokyo">Jap√≥n (UTC+9)</option>
                        </optgroup>
                        <optgroup label="Otros">
                            <option value="Australia/Sydney">Australia - S√≠dney (UTC+10)</option>
                            <option value="Pacific/Auckland">Nueva Zelanda (UTC+12)</option>
                        </optgroup>
                    </select>
                    <div class="descripcion-campo">
                        Se utilizar√° para mostrar fechas y horas en tu zona horaria local
                    </div>
                </div>
            </div>

            <!-- SECCI√ìN 2: VISIBILIDAD DEL PERFIL (RP2) -->
            <div class="seccion-ajustes">
                <h3>
                    <span class="icono-seccion">üëÅÔ∏è</span>
                    Visibilidad del Perfil
                </h3>

                <div class="grupo-control">
                    <label class="etiqueta etiqueta-obligatoria">¬øQui√©n puede ver tu perfil?</label>
                    <div class="descripcion-campo" style="margin-bottom: 15px;">
                        Controla qui√©n puede acceder a tu informaci√≥n de perfil
                    </div>

                    <div class="opciones-radio">
                        <div class="opcion-radio">
                            <input type="radio" name="visibilidad_perfil" id="visiPublico" value="publico" required>
                            <label for="visiPublico" class="etiqueta-opcion">
                                <span class="titulo-opcion">üåç P√∫blico</span>
                                <span class="descripcion-opcion">
                                    Cualquier persona puede ver tu perfil, incluidos usuarios no registrados
                                </span>
                            </label>
                        </div>

                        <div class="opcion-radio">
                            <input type="radio" name="visibilidad_perfil" id="visiVerificados" value="solo_verificados" required>
                            <label for="visiVerificados" class="etiqueta-opcion">
                                <span class="titulo-opcion">‚úîÔ∏è Solo Usuarios Verificados</span>
                                <span class="descripcion-opcion">
                                    Solo pueden ver tu perfil los usuarios que han completado la verificaci√≥n de identidad
                                </span>
                            </label>
                        </div>

                        <div class="opcion-radio">
                            <input type="radio" name="visibilidad_perfil" id="visiPrivado" value="privado" required>
                            <label for="visiPrivado" class="etiqueta-opcion">
                                <span class="titulo-opcion">üîí Privado</span>
                                <span class="descripcion-opcion">
                                    Solo puedes ver tu propio perfil. Otros usuarios no podr√°n acceder a tu informaci√≥n
                                </span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECCI√ìN 3: NOTIFICACIONES -->
            <div class="seccion-ajustes">
                <h3>
                    <span class="icono-seccion">üîî</span>
                    Configuraci√≥n de Notificaciones
                </h3>

                <div class="grupo-control">
                    <label class="etiqueta">Recibir notificaciones por email</label>
                    <div class="opciones-radio">
                        <div class="opcion-radio">
                            <input type="radio" name="notificaciones_email" id="notiEmailSi" value="si" required>
                            <label for="notiEmailSi" class="etiqueta-opcion">
                                <span class="titulo-opcion">üìß S√≠, recibir notificaciones por email</span>
                                <span class="descripcion-opcion">Recibir√°s avisos sobre mensajes, solicitudes y rese√±as</span>
                            </label>
                        </div>
                        <div class="opcion-radio">
                            <input type="radio" name="notificaciones_email" id="notiEmailNo" value="no" required>
                            <label for="notiEmailNo" class="etiqueta-opcion">
                                <span class="titulo-opcion">üö´ No, no quiero notificaciones por email</span>
                                <span class="descripcion-opcion">Solo recibir√°s notificaciones dentro de la aplicaci√≥n</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="grupo-control">
                    <label class="etiqueta">Frecuencia de sugerencias por email</label>
                    <select name="frecuencia_sugerencias" id="frecuenciaSugerencias" required>
                        <option value="">Selecciona frecuencia</option>
                        <option value="diario">Diario - Recibir sugerencias todos los d√≠as</option>
                        <option value="semanal">Semanal - Recibir sugerencias una vez por semana</option>
                        <option value="nunca">Nunca - No recibir sugerencias por email</option>
                    </select>
                    <div class="descripcion-campo">
                        Esta configuraci√≥n controla con qu√© frecuencia recibes sugerencias personalizadas
                    </div>
                </div>
            </div>

            <!-- Botones de acci√≥n -->
            <div class="seccion-ajustes">
                <div class="botones-accion">
                    <button type="submit" class="boton boton-guardar" id="btnGuardar">
                        <span id="indicadorGuardando"></span>
                        Guardar Cambios
                    </button>
                    <button type="button" class="boton boton-cancelar" onclick="volverAtras()">
                        Cancelar
                    </button>
                </div>
            </div>
        </form>
    </div>

    <script>
        console.log('=' .repeat(60));
        console.log('üöÄ SCRIPT DE AJUSTES INICIADO');
        console.log('=' .repeat(60));
        
        // Estado global
        let estadoSesion = {
            token: null,
            usuarioId: null,
            valido: false
        };
        
        // Verificar si hay sesi√≥n v√°lida
        function validarSesion() {
            console.log('\nüîç VALIDANDO SESI√ìN...');
            
            // Buscar token en todos los lugares
            let token = localStorage.getItem('token_usuario') 
                     || sessionStorage.getItem('token_usuario')
                     || localStorage.getItem('token')
                     || sessionStorage.getItem('token');
            
            // Buscar datos de usuario
            let datosUsuario = localStorage.getItem('datos_usuario');
            
            console.log('   Token encontrado:', !!token);
            console.log('   Datos usuario encontrados:', !!datosUsuario);
            
            if (!token) {
                console.log('‚ùå NO HAY TOKEN - Sesi√≥n inv√°lida');
                return false;
            }
            
            if (!datosUsuario) {
                console.log('‚ö†Ô∏è  Token existe pero sin datos de usuario');
                // Intentar decodificar token para obtener usuario_id
                try {
                    const parts = token.split('.');
                    if (parts.length === 3) {
                        let payload64 = parts[1];
                        payload64 = payload64.replace(/-/g, '+').replace(/_/g, '/');
                        const pad = payload64.length % 4;
                        if (pad) payload64 += '='.repeat(4 - pad);
                        const payload = JSON.parse(atob(payload64));
                        console.log('   Usuario ID del token:', payload.usuario_id);
                    }
                } catch (e) {
                    console.error('Error decodificando token:', e);
                }
            }
            
            estadoSesion.token = token;
            estadoSesion.valido = true;
            
            console.log('‚úÖ Sesi√≥n V√ÅLIDA');
            return true;
        }
        
        // Inicializar cuando el DOM est√° listo
        document.addEventListener('DOMContentLoaded', function() {
            console.log('\nüìÑ DOM COMPLETAMENTE CARGADO');
            
            // Validar sesi√≥n inmediatamente
            if (!validarSesion()) {
                console.log('üîÑ Esperando navegaci√≥n.js...');
                // Dar tiempo a que navegacion.js se cargue
                setTimeout(function() {
                    console.log('‚è∞ SEGUNDO INTENTO DE VALIDACI√ìN');
                    if (!validarSesion()) {
                        console.log('‚ùå VALIDACI√ìN FALL√ì - REDIRIGIENDO A LOGIN');
                        setTimeout(() => {
                            window.location.href = '/proyectoWeb/viajeros_peru/app/vistas/auth/iniciar_sesion.html';
                        }, 500);
                        return;
                    }
                    verificarAutenticacion();
                }, 1000);
            } else {
                verificarAutenticacion();
            }
        });
        
        // Escuchar evento de navegacion cargada si existe
        window.addEventListener('navegacionCargada', function() {
            console.log('üëÇ Evento de navegaci√≥n cargada recibido');
        });
        
        // Verificar si el usuario est√° autenticado
        function verificarAutenticacion() {
            let token = estadoSesion.token || localStorage.getItem('token_usuario');
            let datosUsuario = localStorage.getItem('datos_usuario');
            
            console.log('\nüîê VERIFICAR AUTENTICACI√ìN');
            console.log('   Token:', token ? token.substring(0, 30) + '...' : 'NO');
            console.log('   Datos usuario:', datosUsuario ? 'S√ç' : 'NO');
            
            if (!token || !datosUsuario) {
                console.log('‚ùå Sesi√≥n incompleta');
                mostrarPantallaCargando();
                setTimeout(() => {
                    window.location.href = '/proyectoWeb/viajeros_peru/app/vistas/auth/iniciar_sesion.html';
                }, 1000);
                return;
            }

            console.log('‚úÖ Sesi√≥n v√°lida, cargando ajustes...');
            cargarAjustes(token);
        }
        
        // Mostrar pantalla de cargando
        function mostrarPantallaCargando() {
            const form = document.getElementById('formularioAjustes');
            if (form) {
                form.innerHTML = '<div style="text-align: center; padding: 50px;"><p>Redirigiendo...</p></div>';
            }
        }        
        // Cargar ajustes del usuario
        function cargarAjustes(token) {
            try {
                // Decodificar JWT
                const parts = token.split('.');
                if (parts.length !== 3) {
                    throw new Error('Token inv√°lido');
                }
                
                let payload64 = parts[1];
                payload64 = payload64.replace(/-/g, '+').replace(/_/g, '/');
                const pad = payload64.length % 4;
                if (pad) payload64 += '='.repeat(4 - pad);
                
                const payload = JSON.parse(atob(payload64));
                const usuarioId = payload.usuario_id || payload.id;

                console.log('üë§ Usuario ID:', usuarioId);

                // Hacer petici√≥n al servidor
                fetch('/proyectoWeb/viajeros_peru/backend/api/perfiles.php?accion=obtener_ajustes&usuario_id=' + usuarioId, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    }
                })
                .then(res => res.json())
                .then(data => {
                    console.log('üì¶ Datos recibidos:', data);
                    if (data.exito && data.ajustes) {
                        rellenarFormulario(data.ajustes);
                    } else {
                        console.log('‚ö†Ô∏è Sin ajustes previos, usando valores por defecto');
                        rellenarFormularioPorDefecto();
                    }
                    configurarFormulario(token, usuarioId);
                })
                .catch(error => {
                    console.error('Error:', error);
                    rellenarFormularioPorDefecto();
                    configurarFormulario(token, usuarioId);
                });

            } catch (error) {
                console.error('Error decodificando token:', error);
                // Limpiar token inv√°lido
                localStorage.removeItem('token_usuario');
                sessionStorage.removeItem('token_usuario');
                window.location.href = '/proyectoWeb/viajeros_peru/app/vistas/auth/iniciar_sesion.html';
            }
        }

        // Rellenar formulario con datos
        function rellenarFormulario(ajustes) {
            document.getElementById('idioma').value = ajustes.idioma || 'es';
            document.getElementById('zonaHoraria').value = ajustes.zona_horaria || 'America/Lima';
            
            if (ajustes.visibilidad_perfil === 'solo_verificados') {
                document.getElementById('visiVerificados').checked = true;
            } else if (ajustes.visibilidad_perfil === 'privado') {
                document.getElementById('visiPrivado').checked = true;
            } else {
                document.getElementById('visiPublico').checked = true;
            }

            if (ajustes.notificaciones_email === 'no') {
                document.getElementById('notiEmailNo').checked = true;
            } else {
                document.getElementById('notiEmailSi').checked = true;
            }

            document.getElementById('frecuenciaSugerencias').value = ajustes.frecuencia_sugerencias || 'semanal';
        }

        // Rellenar con valores por defecto
        function rellenarFormularioPorDefecto() {
            document.getElementById('idioma').value = 'es';
            document.getElementById('zonaHoraria').value = 'America/Lima';
            document.getElementById('visiPublico').checked = true;
            document.getElementById('notiEmailSi').checked = true;
            document.getElementById('frecuenciaSugerencias').value = 'semanal';
        }

        // Configurar el env√≠o del formulario
        function configurarFormulario(token, usuarioId) {
            document.getElementById('formularioAjustes').addEventListener('submit', function(e) {
                e.preventDefault();

                const btn = document.getElementById('btnGuardar');
                const loader = document.getElementById('indicadorGuardando');
                
                btn.disabled = true;
                loader.innerHTML = '<span class="cargando"></span>';

                const datos = {
                    accion: 'actualizar_ajustes',
                    usuario_id: usuarioId,
                    idioma: document.getElementById('idioma').value,
                    zona_horaria: document.getElementById('zonaHoraria').value,
                    visibilidad_perfil: document.querySelector('input[name="visibilidad_perfil"]:checked').value,
                    notificaciones_email: document.querySelector('input[name="notificaciones_email"]:checked').value,
                    frecuencia_sugerencias: document.getElementById('frecuenciaSugerencias').value
                };

                console.log('üì§ Enviando:', datos);

                fetch('/proyectoWeb/viajeros_peru/backend/api/perfiles.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(datos)
                })
                .then(res => res.json())
                .then(data => {
                    console.log('‚úÖ Respuesta:', data);
                    btn.disabled = false;
                    loader.innerHTML = '';

                    if (data.exito) {
                        mostrarMensaje('exito');
                        setTimeout(() => ocultarMensaje('exito'), 3000);
                        // Propagar cambio de idioma a la UI cliente
                        try {
                            const nuevoIdioma = datos.idioma;
                            if (nuevoIdioma) {
                                localStorage.setItem('idioma_preferido', nuevoIdioma);

                                // Actualizar datos_usuario si existe
                                const du = localStorage.getItem('datos_usuario');
                                if (du) {
                                    try {
                                        const obj = JSON.parse(du);
                                        obj.idioma = nuevoIdioma;
                                        localStorage.setItem('datos_usuario', JSON.stringify(obj));
                                    } catch (e) {
                                        console.warn('No se pudo actualizar datos_usuario con idioma:', e);
                                    }
                                }

                                // Si la navegaci√≥n global est√° cargada, pedirle que aplique el idioma
                                if (window.navegacionGlobal && typeof navegacionGlobal.aplicarIdioma === 'function') {
                                    navegacionGlobal.aplicarIdioma(nuevoIdioma);
                                } else {
                                    // Emitir evento para que cualquier escucha (p. ej. navegaci√≥n) reaccione
                                    window.dispatchEvent(new CustomEvent('idiomaCambiado', { detail: { idioma: nuevoIdioma } }));
                                }
                            }
                        } catch (e) {
                            console.warn('No se pudo propagar idioma al cliente:', e);
                        }
                    } else {
                        mostrarMensaje('error');
                        setTimeout(() => ocultarMensaje('error'), 3000);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    btn.disabled = false;
                    loader.innerHTML = '';
                    mostrarMensaje('error');
                    setTimeout(() => ocultarMensaje('error'), 3000);
                });
            });
        }

        // Mostrar mensaje
        function mostrarMensaje(tipo) {
            const elemento = document.getElementById('mensaje' + (tipo === 'exito' ? 'Exito' : 'Error'));
            if (elemento) {
                elemento.classList.add('mostrar');
            }
        }

        // Ocultar mensaje
        function ocultarMensaje(tipo) {
            const elemento = document.getElementById('mensaje' + (tipo === 'exito' ? 'Exito' : 'Error'));
            if (elemento) {
                elemento.classList.remove('mostrar');
            }
        }

        // Volver atr√°s
        function volverAtras() {
            window.history.back();
        }
    </script>
    <!-- Cargar navegaci√≥n al final para que no interfiera -->
    <script src="/proyectoWeb/viajeros_peru/public/js/componentes/navegacion.js"></script>
</body>
</html>
